<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANTON ARMY BATTLE</title>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #start-banner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 30%, #1a1a1a 60%, #0d0d0d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10000;
            animation: bannerGlow 3s ease-in-out infinite alternate;
        }

        @keyframes bannerGlow {
            0% { box-shadow: inset 0 0 50px rgba(164, 184, 72, 0.3); }
            100% { box-shadow: inset 0 0 100px rgba(164, 184, 72, 0.6); }
        }

        .banner-content {
            text-align: center;
            animation: fadeInUp 2s ease-out;
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(50px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .banner-title {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px #a4b848, 0 0 40px #c4d86f;
            margin-bottom: 1rem;
            letter-spacing: 3px;
        }

        .banner-subtitle {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: #a4b848;
            text-shadow: 0 0 10px rgba(164, 184, 72, 0.5);
            margin-bottom: 3rem;
            letter-spacing: 3px;
            font-weight: 400;
        }

        @keyframes textGlow {
            0% { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); }
            100% { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 15px #e8f4a0; }
        }

        #start-game-button {
            padding: 20px 50px;
            background: linear-gradient(45deg, #a4b848, #c4d86f);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(164, 184, 72, 0.8), 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            animation: buttonPulse 2s ease-in-out infinite;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes buttonPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #start-game-button:hover {
            background: linear-gradient(45deg, #c4d86f, #ffab52);
            box-shadow: 0 0 40px rgba(164, 184, 72, 1), 0 15px 30px rgba(0, 0, 0, 0.4);
            transform: translateY(-3px) scale(1.05);
        }

        #start-game-button:active {
            transform: translateY(0) scale(0.98);
        }

        /* Canton cup decoration */
        .Canton-decoration {
            position: absolute;
            font-size: 4rem;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        .Canton-decoration.top-left {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .Canton-decoration.top-right {
            top: 15%;
            right: 15%;
            animation-delay: 1s;
        }

        .Canton-decoration.bottom-left {
            bottom: 20%;
            left: 20%;
            animation-delay: 2s;
        }

        .Canton-decoration.bottom-right {
            bottom: 10%;
            right: 10%;
            animation-delay: 1.5s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Hide main game elements initially */
        .game-hidden {
            display: none !important;
        }

        body {
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            background-size: 400% 400%;
            animation: CantonFlow 3s ease infinite;
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            user-select: none;
        }

        @keyframes CantonFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-container {
            background: radial-gradient(circle at center, rgba(164, 184, 72, 0.1) 0%, transparent 70%);
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        .hud {
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(164, 184, 72, 0.3);
        }

        .stat-label {
            color: #c4d86f;
        }

        .stat-value {
            color: #a4b848;
            text-shadow: 0 0 10px rgba(164, 184, 72, 0.5);
        }

        #privacy-bar-container {
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(164, 184, 72, 0.3);
        }

        #privacy-bar {
            background: linear-gradient(90deg, #a4b848 0%, #8a9a3b 100%);
            -shadow: 0 0 15px rgba(164, 184, 72, 0.8);
        }

        #game-over {
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 0 50px rgba(164, 184, 72, 0.5);
        }

        .game-over-title {
            color: #a4b848;
            text-shadow: 0 0 20px rgba(164, 184, 72, 0.8);
        }

        .title {
            position: absolute;
            top: 8px;
            font-size: 2rem;
            font-weight: 900;
            color: #a4b848;
            text-shadow: 3px 3px 0px #000, -1px -1px 0px #fff;
            z-index: 100;
        }

        .control-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            padding: 10px 15px;
            background: linear-gradient(45deg, #a4b848, #c4d86f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px rgba(164, 184, 72, 0.5);
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .control-btn.muted {
            background: linear-gradient(45deg, #666, #888);
            color: #ccc;
        }

        .rules-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 4px solid #a4b848;
            color: #a4b848;
            text-align: left;
            font-size: 0.9rem;
            font-weight: bold;
            display: none;
            z-index: 2000;
            max-width: 420px;
            max-height: 70vh;
            width: 90%;
            box-shadow: 0 0 30px rgba(164, 184, 72, 0.8);
            overflow-y: auto;
        }
        

        .rules-popup h2 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #a4b848;
            text-shadow: 2px 2px 0px black;
        }

        .rules-popup ul {
            list-style: none;
            padding: 0;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .rules-popup li {
            margin: 8px 0;
            text-shadow: 1px 1px 0px black;
            font-size: 0.85rem;
        }

        .rules-close-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(45deg, #a4b848, #c4d86f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            width: 100%;
            transition: transform 0.2s ease;
        }

        .rules-close-btn:hover {
            transform: scale(1.05);
        }

        /* Custom scrollbar for rules popup */
        .rules-popup::-webkit-scrollbar {
            width: 8px;
        }

        .rules-popup::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        .rules-popup::-webkit-scrollbar-thumb {
            background: #a4b848;
            border-radius: 4px;
        }

        .rules-popup::-webkit-scrollbar-thumb:hover {
            background: #c4d86f;
        }

        /* DESKTOP ARENA - LARGE SIZE */
        .arena {
            width: 800px;
            height: 600px;
            border: 5px solid #ff0000;
            border-radius: 20px;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            overflow: hidden;
            animation: arenaPulse 2s infinite;
        }

        @keyframes arenaPulse {
            0%, 100% { border-color: #ff0000; }
            50% { border-color: #8b0000; }
        }

        .node {
            position: absolute;
            width: 30px;
            height: 40px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0px black;
            animation: bounce 2s infinite;
        }

        .node.player {
            background: transparent;
            box-shadow: 0 0 30px rgba(164, 184, 72, 1), 0 0 60px rgba(164, 184, 72, 0.5);
            z-index: 10;
            border: 3px solid #a4b848;
            width: 60px !important;
            height: 60px !important;
            border-radius: 50%;
        }


        .node.enemy {
            background: linear-gradient(45deg, #2f1b14, #5d4037);
            box-shadow: 0 0 10px rgba(95, 64, 55, 0.6);
        }

        .node.super {
            background: linear-gradient(45deg, #a4b848, #c4d86f);
            box-shadow: 0 0 20px rgba(164, 184, 72, 1);
            animation: superPulse 0.5s infinite;
        }

        .node.poison {
            background: linear-gradient(45deg, #4b0082, #8b008b);
            box-shadow: 0 0 20px rgba(139, 0, 139, 1);
            animation: poisonPulse 0.8s infinite;
            border: 2px solid #00ff00;
        }

        .node.poison.expiring {
            animation: poisonExpiring 1s infinite;
        }

        @keyframes poisonExpiring {
            0%, 100% { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% { 
                opacity: 0.3;
                transform: scale(0.8) rotate(180deg);
            }
        }

        @keyframes poisonPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                box-shadow: 0 0 20px rgba(139, 0, 139, 1);
            }
            50% { 
                transform: scale(1.1) rotate(180deg);
                box-shadow: 0 0 25px rgba(0, 255, 0, 1);
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes superPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }

        .node.deadly-poison {
            background: linear-gradient(45deg, #8b0000, #ff0000);
            box-shadow: 0 0 25px rgba(255, 0, 0, 1);
            animation: deadlyPulse 0.6s infinite;
            border: 3px solid #ff0000;
        }

        @keyframes deadlyPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                box-shadow: 0 0 25px rgba(255, 0, 0, 1);
            }
            50% { 
                transform: scale(1.2) rotate(180deg);
                box-shadow: 0 0 35px rgba(255, 0, 0, 1.5);
            }
        }

        .node.deadly-poison.expiring {
            animation: deadlyExpiring 1s infinite;
        }

        @keyframes deadlyExpiring {
            0%, 100% { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% { 
                opacity: 0.2;
                transform: scale(0.7) rotate(180deg);
            }
        }

        .stats {
            position: absolute;
            top: 80px;
            left: 20px;
            color: #a4b848;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 0px black;
            z-index: 100;
        }

        .health-bar {
            position: absolute;
            top: 220px;
            left: 20px;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .health-label {
            color: #a4b848;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 0px black;
            margin-right: 10px;
        }

        .health-hearts {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .health-heart {
            font-size: 1.3rem;
            color: #ff0000;
            text-shadow: 1px 1px 0px black;
            animation: heartBeat 2s infinite;
        }

        .health-heart.lost {
            color: #444;
            animation: none;
            opacity: 0.3;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 900;
            color: #a4b848;
            text-shadow: 3px 3px 0px black;
            pointer-events: none;
            opacity: 0;
            animation: comboFlash 1s ease;
        }

        @keyframes comboFlash {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .health-damage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 3px 3px 0px black;
            pointer-events: none;
            opacity: 0;
            animation: healthDamageFlash 1.5s ease;
        }

        @keyframes healthDamageFlash {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .miss-penalty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 2px 2px 0px #000;
            pointer-events: none;
            opacity: 0;
            animation: missFlashSimple 1.5s ease;
            z-index: 100;
        }

        @keyframes missFlashSimple {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8); 
            }
            30% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.1); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }

        .poison-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 3px 3px 0px black;
            pointer-events: none;
            opacity: 0;
            animation: poisonWarning 1.5s ease;
        }

        @keyframes poisonWarning {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            color: #a4b848;
            font-size: 0.8rem;
            text-align: center;
            text-shadow: 1px 1px 0px black;
        }

        .privacy-meter {
            position: absolute;
            top: 150px;
            right: 20px;
            width: 25px;
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border: 4px solid #a4b848;
            border-radius: 12px;
            overflow: hidden;
        }

        .privacy-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #a4b848, #ffff00);
            transition: height 0.2s ease;
            border-radius: 0 0 8px 8px;
        }

        .privacy-level.critical {
            background: linear-gradient(to top, #8b0000, #ff0000);
            animation: criticalFlash 0.2s infinite;
        }

        @keyframes criticalFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            color: #a4b848;
            animation: particleFloat 1s ease-out forwards;
        }

        .particle.poison {
            color: #8b008b;
            animation: poisonParticleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) rotate(360deg);
            }
        }

        @keyframes poisonParticleFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) rotate(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px) rotate(-360deg) scale(1.5);
            }
        }

        .splash-effect {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            font-weight: bold;
            animation: splashAnimation 0.8s ease-out forwards;
            z-index: 50;
        }

        .splash-effect.super {
            color: #a4b848;
            text-shadow: 2px 2px 0px #000;
        }

        .splash-effect.enemy {
            color: #ffff00;
            text-shadow: 2px 2px 0px #000;
        }

        .splash-effect.poison {
            color: #8b008b;
            text-shadow: 2px 2px 0px #000;
        }

        @keyframes splashAnimation {
            0% {
                opacity: 1;
                transform: scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.3) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(1.8) rotate(360deg);
            }
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 20px;
            border: 5px solid #a4b848;
            color: #a4b848;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            display: none;
            z-index: 1000;
        }

        .restart-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #a4b848 0%, #8a9a3b 100%);
            box-shadow: 0 0 20px rgba(164, 184, 72, 0.5);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            transition: transform 0.2s ease;
        }

        .restart-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #8a9a3b 0%, #a4b848 100%);
            box-shadow: 0 0 30px rgba(164, 184, 72, 0.8);
        }

        /* MOBILE RESPONSIVE STYLES */
        @media screen and (max-width: 768px) {
            .game-container {
                padding: 0;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .title {
                font-size: 1.5rem;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 200;
                position: fixed;
            }

            .control-buttons {
                top: 10px;
                right: 10px;
                z-index: 200;
                position: fixed;
            }

            .control-btn {
                padding: 8px;
                font-size: 1.3rem;
                width: 45px;
                height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 15px rgba(164, 184, 72, 0.8);
                border: 2px solid #fff;
            }

            /* MOBILE ARENA - SMALLER SIZE */
            .arena {
                width: 350px !important;
                height: 280px !important;
                position: relative;
                margin: 0 auto;
                border: 4px solid #ff0000 !important;
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            }

            .stats {
                position: fixed;
                top: 60px;
                left: 10px;
                font-size: 0.8rem;
                z-index: 150;
                line-height: 1.2;
                background: rgba(0, 0, 0, 0.7);
                padding: 5px;
                border-radius: 5px;
            }

            .health-bar {
                position: fixed;
                top: 140px;
                left: 10px;
                z-index: 150;
                background: rgba(0, 0, 0, 0.7);
                padding: 5px;
                border-radius: 5px;
            }

            .health-label {
                font-size: 0.8rem;
            }

            .health-heart {
                font-size: 0.9rem;
            }

            .privacy-meter {
                position: fixed;
                top: 60px;
                right: 10px;
                width: 18px;
                height: 100px;
                z-index: 150;
            }

            .instructions {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.6rem;
                text-align: center;
                width: 90%;
                z-index: 150;
                background: rgba(0, 0, 0, 0.7);
                padding: 5px;
                border-radius: 5px;
            }

            .node {
                width: 28px !important;
                height: 35px !important;
                font-size: 18px !important;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                transition: transform 0.1s ease;
            }
            
            .node:active {
                transform: scale(1.2);
            }

            /* SMALLER WARNING TEXTS FOR MOBILE */
            .miss-penalty {
                font-size: 1rem !important;
            }
            
            .health-damage {
                font-size: 1rem !important;
            }
            
            .poison-warning {
                font-size: 1rem !important;
            }
            
            .combo-display {
                font-size: 2rem !important;
            }

            .game-over {
                width: 90%;
                max-width: 300px;
                padding: 15px;
                font-size: 1rem;
            }

            .restart-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            /* Start banner mobile */
            .banner-title {
                font-size: 1.8rem;
            }

            .banner-subtitle {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: #a4b848;
            text-shadow: 0 0 10px rgba(164, 184, 72, 0.5);
            margin-bottom: 3rem;
            letter-spacing: 3px;
            font-weight: 400;
        }

            #start-game-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }

            .Canton-decoration {
                font-size: 1.5rem;
            }

            .rules-popup {
                max-width: 280px;
                max-height: 70vh;
                padding: 15px;
                font-size: 0.7rem;
            }

            .rules-popup h2 {
                font-size: 1.1rem;
            }

            .rules-popup li {
                font-size: 0.7rem;
                margin: 4px 0;
            }
        }

        /* VERY SMALL SCREENS */
        @media screen and (max-width: 480px) {
            .arena {
                width: 280px !important;
                height: 200px !important;
            }

            .node {
                width: 25px !important;
                height: 30px !important;
                font-size: 16px !important;
            }
            
            .health-damage {
                font-size: 0.9rem !important;
            }
        }

        /* TOUCH IMPROVEMENTS */
        .node {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            touch-action: manipulation;
        }

        .control-btn, .restart-btn, .rules-close-btn, #start-game-button {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Prevent text selection on mobile */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* LANDSCAPE NUCLEAR OVERRIDE - KEEP CORE, ADJUST POSITIONS ONLY */
@media screen and (max-height: 500px) and (orientation: landscape) {
    /* STATS - KEEP AS IS */
    .stats {
        position: fixed !important;
        top: 1px !important;
        left: 1px !important;
        font-size: 0.6rem !important;
        z-index: 999 !important;
        line-height: 1 !important;
        background: rgba(0, 0, 0, 0.95) !important;
        padding: 3px !important;
        border-radius: 2px !important;
        width: 70px !important;
        height: auto !important;
        display: block !important;
        visibility: visible !important;
        opacity: 0.9 !important;
    }

    /* HEALTH BAR - UNDER STATS, NO BACKGROUND */
    .health-bar {
        position: fixed !important;
        top: 45px !important; /* Under stats instead of bottom */
        left: 1px !important;
        z-index: 999 !important;
        background: none !important; /* No background */
        border: none !important; /* No border */
        padding: 0 !important; /* No padding */
        border-radius: 0 !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        width: auto !important;
        height: auto !important;
        visibility: visible !important;
        opacity: 1 !important; /* Full opacity for hearts */
        box-shadow: none !important; /* No shadow */
    }

    .health-label {
        display: none !important; /* Hide label */
    }

    .health-heart {
    font-size: 0.49rem !important; /* 30% smaller than current 0.7rem */
    margin: 0 1px !important;
    display: inline !important;
    position: relative !important;
    top: 20px !important; /* Move hearts down 10px more */
}


    .title {
        font-size: 1.6rem !important;
        top: 10px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 999 !important;
        position: fixed !important;
        display: block !important;
        visibility: visible !important;
    }

    /* CONTROL BUTTONS - BIGGER ICON-ONLY */
    .control-buttons {
        position: fixed !important;
        top: 1px !important;
        right: 1px !important;
        z-index: 999 !important;
        display: flex !important;
        gap: 3px !important;
        visibility: visible !important;
    }

    .control-btn {
        padding: 2px !important;
        font-size: 1rem !important; /* Bigger icons */
        width: 50px !important; /* Bigger buttons */
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: none !important;
        border: 1px solid #fff !important;
        visibility: visible !important;
        background: linear-gradient(45deg, #a4b848, #c4d86f) !important;
        border-radius: 6px !important;
    }

    /* PRIVACY METER - NEXT TO ARENA ON RIGHT */
    .privacy-meter {
        position: fixed !important;
        top: 50% !important;
        right: 5px !important; /* Right side next to arena */
        transform: translateY(-50%) !important;
        width: 16px !important;
        height: 240px !important; /* Taller */
        z-index: 999 !important;
        border: 1px solid #a4b848 !important;
        visibility: visible !important;
    }

    /* INSTRUCTIONS - UNDER ARENA CENTER */
    .instructions {
        position: fixed !important;
        bottom: 5px !important;
        left: 50% !important; /* Center horizontally */
        transform: translateX(-50%) !important;
        font-size: 0.6rem !important;
        text-align: center !important;
        width: 600px !important;
        z-index: 999 !important;
        background: rgba(0, 0, 0, 0.95) !important;
        padding: 3px !important;
        border-radius: 2px !important;
        visibility: visible !important;
        opacity: 0.9 !important;
    }

    /* ARENA STAYS LARGE AND CENTERED - UNCHANGED */
    .arena {
        width: 90vw !important;
        height: 70vh !important;
        max-width: 500px !important;
        max-height: 250px !important;
        position: relative !important;
        margin: 0 auto !important;
        border: 2px solid #ff0000 !important;
        border-radius: 8px !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.6) !important;
        display: block !important;
        visibility: visible !important;
    }

    /* GAME CONTAINER CENTERED - UNCHANGED */
    .game-container {
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        position: relative !important;
    }

    /* WARNING TEXTS - UNCHANGED */
    .miss-penalty,
    .health-damage,
    .poison-warning {
        font-size: 0.8rem !important;
        transform: translate(-50%, -50%) !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        z-index: 100 !important;
    }
    
    .combo-display {
        font-size: 1.2rem !important;
        transform: translate(-50%, -50%) !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        z-index: 100 !important;
    }

    /* NODES STAY TOUCHABLE - UNCHANGED */
    .node {
        width: 24px !important;
        height: 28px !important;
        font-size: 14px !important;
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: transparent !important;
        transition: transform 0.1s ease !important;
        position: absolute !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        visibility: visible !important;
    }
    
    .node:active {
        transform: scale(1.1) !important;
    }
}

    
        .banner-title, .game-title {
            background: linear-gradient(90deg, #ffffff 0%, #ffffff 50%, #a4b848 50%, #a4b848 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

    </style>

</head>
<body>
    <div class="game-container">
        <!-- START BANNER -->
<div id="start-banner">
    <div class="banner-content">
    <div class="banner-logo">
        <img src="cn-favicon-05 1-1.webp" alt="Canton Logo" style="width: 150px; height: 150px; margin-bottom: 2rem; border-radius: 50%; box-shadow: 0 0 30px rgba(164, 184, 72, 0.6), 0 0 60px rgba(164, 184, 72, 0.4);">
    </div>

        <h1 class="banner-title">CANTON ARMY BATTLE</h1>
        <p class="banner-subtitle">COMMUNITY-POWERED MOVEMENT</p>
        <button id="start-game-button">‚öîÔ∏è JOIN THE ARMY ‚öîÔ∏è</button>
    </div>
    
    <!-- Canton decorations -->
    
    
    <div class="Canton-decoration bottom-left"></div>
    
</div>

        <div class="title">‚öîÔ∏è CANTON ARMY BATTLE </div>
        
        <div class="control-buttons">
            <button class="control-btn" id="muteBtn" onclick="toggleMute()">üîä SOUND</button>
            <button class="control-btn" onclick="showRules()">üìã RULES</button>
        </div>

        <div class="rules-popup" id="rulesPopup">
            <h2>‚öîÔ∏è CANTON ARMY BATTLE RULES </h2>
            <ul>
                <li>üéØ <strong>OBJECTIVE:</strong> Defend your Canton fortress by destroying enemy targets!</li>
                <li> <strong>SUPER TARGETS ():</strong> Give 50 points + big privacy boost</li>
                <li>‚ö´ <strong>REGULAR TARGETS:</strong> Give 10 points + small privacy boost</li>
                <li>‚ò†Ô∏è <strong>MALICIOUS TARGETS:</strong> Drain 10% privacy if clicked - let them expire naturally!</li>
                <li>‚ù§Ô∏è <strong>HEALTH SYSTEM:</strong> Start with 10 hearts - lose 1 for each missed targets</li>
                <li>‚öîÔ∏è <strong>PRIVACY SHIELD:</strong> Constantly drains - keep it above 0 or game over!</li>
                <li>üî• <strong>COMBO SYSTEM:</strong> Hit targets consecutively to multiply your score</li>
                <li>üíÄ <strong>MISS PENALTY:</strong> -50 points + -1 health for targets reaching center</li>
                <li>üéØ <strong>PRECISION:</strong> Miss-clicks reset your combo to zero</li>
                <li>‚è∞ <strong>TIME LIMIT:</strong> 30 seconds + bonuses from leveling up</li>
                <li>üìà <strong>DIFFICULTY:</strong> Targets move 0.1x faster every 1000 points</li>
                <li>üèÜ <strong>WIN CONDITIONS:</strong> Survive as long as possible for high score!</li>
            </ul>
            <button class="rules-close-btn" onclick="hideRules()">GOT IT! ‚öîÔ∏è</button>
        </div>
        
        <div class="stats">
            <div>SCORE: <span id="score">0</span></div>
            <div>COMBO: <span id="combo">0</span></div>
            <div>LEVEL: <span id="level">1</span></div>
            <div>TIME: <span id="time">30</span>s</div>
            <div>MISSED: <span id="missed">0</span></div>
        </div>

        <div class="health-bar">
            <div class="health-label">HEALTH:</div>
            <div class="health-hearts" id="healthHearts">
                <!-- Health hearts will be generated here -->
            </div>
        </div>

        <div class="privacy-meter">
            <div class="privacy-level" id="privacyLevel"></div>
        </div>

        <div class="arena" id="arena">
            <!-- Beans spawn here -->
        </div>

        <div class="instructions">
          CLICK ENEMY TARGETS TO DESTROY! ‚ò†Ô∏è MALICIOUS TARGETS DRAIN PRIVACY! üíÄ CRITICAL THREAT REMOVES HEALTH!<br>
    üéØ      MISS PENALTY: -1 HEALTH | üíÄ DON'T MISS-CLICK OR COMBO RESETS!
        </div>


        <div class="game-over" id="gameOver">
            <div>GAME OVER!</div>
            <div>Final Score: <span id="finalScore">0</span></div>
            <div>Targets Destroyed: <span id="finalBeans">0</span></div>
            <div>Targets Missed: <span id="finalMissed">0</span></div>
            <div>Best Combo: <span id="finalBestCombo">0</span></div>
            <button class="restart-btn" onclick="restartGame()">FIGHT AGAIN ‚öîÔ∏è</button>
        </div>
    </div>

   <script>
let soundEnabled = true;
let audioContext = null;

function initAudio() {
    if (!audioContext) {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('Audio context created:', audioContext.state);
        } catch (e) {
            console.error('Failed to create audio context:', e);
        }
    }
}

function playTone(frequency, duration, type = 'sine') {
    if (!soundEnabled || !audioContext) return;
    
    try {
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                actuallyPlayTone(frequency, duration, type);
            });
        } else {
            actuallyPlayTone(frequency, duration, type);
        }
    } catch (e) {
        console.error('Error in playTone:', e);
    }
}

function actuallyPlayTone(frequency, duration, type) {
    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = type;
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
        
    } catch (e) {
        console.error('Error in actuallyPlayTone:', e);
    }
}

class BeanBattleRoyale {
    constructor() {
        this.arena = document.getElementById('arena');
        this.score = 0;
        this.combo = 0;
        this.bestCombo = 0;
        this.level = 1;
        this.time = 30;
        this.privacyLevel = 100;
        this.nodesDestroyed = 0;
        this.nodesMissed = 0;
        this.health = 10;
        this.gameRunning = true;
        this.nodes = [];
        
        this.isMobile = window.innerWidth <= 768;
        this.spawnRate = 800; 
        this.maxBeans = this.isMobile ? 8 : 15; 
        this.privacyDecay = 8; 
        this.poisonLifetime = 5000;
        
        this.updateArenaDimensions();
        
        this.baseBeanSpeed = 1.0;
        this.nodeSpeed = this.baseBeanSpeed;
        this.difficultyLevel = 0;
        
        this.initGame();
        this.gameLoop();
        this.spawnLoop();
        this.timer();
        this.setupClickHandler();
    }

updateArenaDimensions() {
    const arenaRect = this.arena.getBoundingClientRect();
    this.arenaWidth = arenaRect.width - 60;
    this.arenaHeight = arenaRect.height - 60;
    
    this.centerX = (arenaRect.width / 2) - 15; 
    this.centerY = (arenaRect.height / 2) - 20; 
}


    initGame() {
        this.initHealthBar();
        this.updateUI();
        this.spawnPlayerBean();
    }

    initHealthBar() {
        const healthHearts = document.getElementById('healthHearts');
        healthHearts.innerHTML = '';
        
        for (let i = 0; i < 10; i++) {
            const heart = document.createElement('div');
            heart.className = 'health-heart';
            heart.innerHTML = '‚ù§Ô∏è';
            heart.id = `heart-${i}`;
            healthHearts.appendChild(heart);
        }
    }

    createSplashEffect(element, nodeType, points) {
        const rect = element.getBoundingClientRect();
        const arenaRect = this.arena.getBoundingClientRect();
        
        const splash = document.createElement('div');
        splash.className = `splash-effect ${nodeType}`;
        
        if (nodeType === 'super') {
            splash.innerHTML = `+${points} `;
        } else if (nodeType === 'enemy') {
            splash.innerHTML = `+${points}`;
        } else if (nodeType === 'poison' || nodeType === 'deadly-poison') {
            splash.innerHTML = 'POISON! ‚ò†Ô∏è';
        }
        
        splash.style.left = (rect.left - arenaRect.left + 15) + 'px';
        splash.style.top = (rect.top - arenaRect.top + 20) + 'px';
        
        this.arena.appendChild(splash);
        
        setTimeout(() => {
            if (splash.parentNode) splash.remove();
        }, 800);
    }

    updateHealthBar() {
        for (let i = 0; i < 10; i++) {
            const heart = document.getElementById(`heart-${i}`);
            if (i >= this.health) {
                heart.className = 'health-heart lost';
                heart.innerHTML = 'üíî';
            } else {
                heart.className = 'health-heart';
                heart.innerHTML = '‚ù§Ô∏è';
            }
        }
    }

    calculateDifficulty() {
        const newDifficultyLevel = Math.floor(this.score / 1000);
        
        if (newDifficultyLevel > this.difficultyLevel) {
            this.difficultyLevel = newDifficultyLevel;
            this.scaleDifficulty();
        }
    }

    scaleDifficulty() {
        this.nodeSpeed = this.baseBeanSpeed + (this.difficultyLevel * 0.1);
    }

    takeDamage() {
        this.health = Math.max(0, this.health - 1);
        this.updateHealthBar();
        this.showHealthDamage();
        
        if (this.health <= 0) {
            this.endGame('FORTRESS DESTROYED! üí•');
        }
    }

    showHealthDamage() {
        const damage = document.createElement('div');
        damage.className = 'health-damage';
        this.arena.appendChild(damage);
        
        setTimeout(() => {
            if (damage.parentNode) damage.remove();
        }, 1500);
    }

    setupClickHandler() {
        this.arena.addEventListener('click', (e) => {
            if (!e.target.classList.contains('node') || e.target.classList.contains('player')) {
                this.resetCombo();
            }
        });
    }

    resetCombo() {
        if (this.combo > 0) {
            this.combo = 0;
            this.updateUI();
        }
    }

    spawnPlayerBean() {
    const playerBean = document.createElement('div');
    playerBean.className = 'node player';
    playerBean.innerHTML = `<img src="cn-favicon-05 1-1.webp" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; display: block;">`;
    
    const arenaRect = this.arena.getBoundingClientRect();
    const centerX = (arenaRect.width / 2) - 25; 
    const centerY = (arenaRect.height / 2) - 25; 
    
    playerBean.style.left = centerX + 'px';
    playerBean.style.top = centerY + 'px';
    this.arena.appendChild(playerBean);
    }


    spawnEnemyBean() {
        if (this.nodes.length >= this.maxBeans || !this.gameRunning) return;

        const node = document.createElement('div');
        const rand = Math.random();
        let nodeType, isSuper = false, isPoison = false;

        if (rand < 0.15) {
            nodeType = 'poison';
            isPoison = true;
            node.className = 'node poison';
            node.innerHTML = '‚ò¢';
        } else if (rand < 0.20) {
            nodeType = 'deadly-poison';
            isPoison = true;
            node.className = 'node deadly-poison';
            node.innerHTML = '‚ò£';
        } else if (rand < 0.35) {
            nodeType = 'super';
            isSuper = true;
            node.className = 'node super';
            node.innerHTML = 'üåÄ';
        } else {
            nodeType = 'enemy';
            node.className = 'node enemy';
            node.innerHTML = ['üéØ', 'üí´', '‚ú®', 'üåü'][Math.floor(Math.random() * 4)];
        }
        
        const side = Math.floor(Math.random() * 4);
        let x, y;
        
        switch(side) {
            case 0: // Top
                x = Math.random() * this.arenaWidth;
                y = 0;
                break;
            case 1: // Right
                x = this.arenaWidth;
                y = Math.random() * this.arenaHeight;
                break;
            case 2: // Bottom
                x = Math.random() * this.arenaWidth;
                y = this.arenaHeight;
                break;
            case 3: // Left
                x = 0;
                y = Math.random() * this.arenaHeight;
                break;
        }
        
        node.style.left = x + 'px';
        node.style.top = y + 'px';
        
        const nodeData = {
            element: node, 
            type: nodeType, 
            spawnTime: Date.now(),
            poisonExpireTime: isPoison ? Date.now() + this.poisonLifetime : null
        };
        
        node.addEventListener('click', (e) => {
            e.stopPropagation();
            this.destroyBean(node, nodeType, nodeData);
        });
        
        this.arena.appendChild(node);
        this.nodes.push(nodeData);
        
        this.moveBean(node);
        
        if (isPoison) {
            setTimeout(() => {
                if (node.parentNode && this.nodes.includes(nodeData)) {
                    node.classList.add('expiring');
                }
            }, this.poisonLifetime - 1000);
            
            setTimeout(() => {
                if (node.parentNode && this.nodes.includes(nodeData)) {
                    this.removeBeanSafely(nodeData);
                }
            }, this.poisonLifetime);
        }
    }

    removeBeanSafely(nodeData) {
        if (nodeData.element.parentNode) {
            nodeData.element.remove();
        }
        this.nodes = this.nodes.filter(b => b !== nodeData);
    }

    moveBean(nodeElement) {
        const startX = parseInt(nodeElement.style.left);
        const startY = parseInt(nodeElement.style.top);

        const targetX = this.centerX + (Math.random() - 0.5) * 100;
        const targetY = this.centerY + (Math.random() - 0.5) * 100;
        
        const baseDuration = 1800 + Math.random() * 1300;
        const duration = baseDuration / (this.nodeSpeed * 1.3);
        const startTime = Date.now();
        
        const animate = () => {
            if (!this.gameRunning || !nodeElement.parentNode) return;
            
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const easeOut = 1 - Math.pow(1 - progress, 3);
            
            const currentX = startX + (targetX - startX) * easeOut;
            const currentY = startY + (targetY - startY) * easeOut;
            
            nodeElement.style.left = currentX + 'px';
            nodeElement.style.top = currentY + 'px';
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                const nodeData = this.nodes.find(b => b.element === nodeElement);
                if (nodeData && nodeData.type !== 'poison' && nodeData.type !== 'deadly-poison') {
                    this.applyMissPenalty(nodeElement);
                } else if (nodeData) {
                    this.removeBeanSafely(nodeData);
                }
            }
        };
        
        animate();
    }

    applyMissPenalty(nodeElement) {
        const nodeData = this.nodes.find(b => b.element === nodeElement);
        if (nodeData) {
            this.nodesMissed++;
            this.takeDamage();
            this.resetCombo();
            this.removeBeanSafely(nodeData);
            this.showMissPenalty();
            this.updateUI();
        }
    }

    showMissPenalty() {
        const penalty = document.createElement('div');
        penalty.className = 'miss-penalty';
        penalty.innerHTML = 'MISSED! -1 ‚ù§Ô∏è';
        this.arena.appendChild(penalty);

        setTimeout(() => {
            if (penalty.parentNode) penalty.remove();
        }, 1500);
    }

    destroyBean(nodeElement, nodeType, nodeData) {
        if (!this.gameRunning || !nodeElement.parentNode) return;
        
        if (nodeType === 'poison') {
            this.privacyLevel = Math.max(0, this.privacyLevel - 10);
            this.resetCombo();
            this.showPoisonWarning();
            this.createSplashEffect(nodeElement, 'poison', 0);
            this.createParticles(nodeElement, true);
            this.removeBeanSafely(nodeData);
            this.updateUI();
            return;
        }
        
        if (nodeType === 'deadly-poison') {
            this.takeDamage();
            this.resetCombo();
            this.showDeadlyPoisonWarning();
            this.createSplashEffect(nodeElement, 'poison', 0);
            this.createParticles(nodeElement, true);
            this.removeBeanSafely(nodeData);
            this.updateUI();
            return;
        }
        
        const points = nodeType === 'super' ? 50 : 10;
        this.score += points * Math.max(1, this.combo);
        this.combo += nodeType === 'super' ? 3 : 1;
        
        if (this.combo > this.bestCombo) {
            this.bestCombo = this.combo;
        }
        
        this.privacyLevel = Math.min(100, this.privacyLevel + (nodeType === 'super' ? 15 : 8));
        this.nodesDestroyed++;
        
        this.createSplashEffect(nodeElement, nodeType, points * Math.max(1, this.combo));
        this.removeBeanSafely(nodeData);
        this.createParticles(nodeElement, false);
        
        if (this.combo > 5) {
            this.showCombo();
        }
        
        this.calculateDifficulty();
        this.updateUI();
        this.checkLevelUp();
    }

    showPoisonWarning() {
        const warning = document.createElement('div');
        warning.className = 'poison-warning';
        warning.innerHTML = 'POISON! ‚ò†Ô∏è';
        this.arena.appendChild(warning);
        
        setTimeout(() => {
            if (warning.parentNode) warning.remove();
        }, 1500);
    }

    showDeadlyPoisonWarning() {
        const warning = document.createElement('div');
        warning.className = 'poison-warning';
        warning.innerHTML = 'CRITICAL THREAT! üíÄ -1‚ù§Ô∏è';
        warning.style.color = '#ff0000';
        this.arena.appendChild(warning);
        
        setTimeout(() => {
            if (warning.parentNode) warning.remove();
        }, 2000);
    }

    createParticles(element, isPoison = false) {
        const rect = element.getBoundingClientRect();
        const arenaRect = this.arena.getBoundingClientRect();
        
        for (let i = 0; i < (isPoison ? 8 : 5); i++) {
            const particle = document.createElement('div');
            particle.className = isPoison ? 'particle poison' : 'particle';
            particle.innerHTML = isPoison 
                ? ['‚ò†Ô∏è', 'üíÄ', '‚ö†Ô∏è', '‚ò¢Ô∏è'][Math.floor(Math.random() * 4)]
                : ['‚ú®', '‚≠ê', 'üí´', '‚òÑÔ∏è'][Math.floor(Math.random() * 4)];
            particle.style.left = (rect.left - arenaRect.left + Math.random() * 30) + 'px';
            particle.style.top = (rect.top - arenaRect.top + Math.random() * 30) + 'px';
            
            this.arena.appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) particle.remove();
            }, isPoison ? 1500 : 1000);
        }
    }

    showCombo() {
        const comboDisplay = document.createElement('div');
        comboDisplay.className = 'combo-display';
        comboDisplay.innerHTML = `COMBO x${this.combo}!`;
        this.arena.appendChild(comboDisplay);
        
        setTimeout(() => {
            if (comboDisplay.parentNode) comboDisplay.remove();
        }, 1000);
    }

    checkLevelUp() {
        const newLevel = Math.floor(this.nodesDestroyed / 10) + 1;
        if (newLevel > this.level) {
            this.level = newLevel;
            this.time += 10;
        }
    }

    updateUI() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('combo').textContent = this.combo;
        document.getElementById('level').textContent = this.level;
        document.getElementById('time').textContent = this.time;
        document.getElementById('missed').textContent = this.nodesMissed;
        
        const privacyLevel = document.getElementById('privacyLevel');
        privacyLevel.style.height = this.privacyLevel + '%';
        
        if (this.privacyLevel <= 15) {
            privacyLevel.className = 'privacy-level critical';
        } else {
            privacyLevel.className = 'privacy-level';
        }
    }

    gameLoop() {
        if (!this.gameRunning) return;
        
        this.privacyLevel = Math.max(0, this.privacyLevel - (this.privacyDecay / 10));
        
        if (this.privacyLevel <= 0) {
            this.endGame('PRIVACY CRASH! ‚ò†Ô∏è');
            return;
        }
        
        this.updateUI();
        setTimeout(() => this.gameLoop(), 100);
    }

    spawnLoop() {
        if (!this.gameRunning) return;
        
        this.spawnEnemyBean();
        setTimeout(() => this.spawnLoop(), this.spawnRate);
    }

    timer() {
        if (!this.gameRunning) return;
        
        this.time--;
        if (this.time <= 0) {
            this.endGame('TIME\'S UP! ‚è∞');
            return;
        }
        
        setTimeout(() => this.timer(), 1000);
    }

    endGame(reason = 'GAME OVER!') {
        this.gameRunning = false;

        this.nodes.forEach(nodeData => {
            if (nodeData.element && nodeData.element.parentNode) {
                nodeData.element.style.pointerEvents = 'none';
                nodeData.element.style.opacity = '0.5';
            }
        });
        
        document.getElementById('gameOver').children[0].textContent = reason;
        document.getElementById('finalScore').textContent = this.score;
        document.getElementById('finalBeans').textContent = this.nodesDestroyed;
        document.getElementById('finalMissed').textContent = this.nodesMissed;
        document.getElementById('finalBestCombo').textContent = this.bestCombo;
        document.getElementById('gameOver').style.display = 'block';
    }
}

function restartGame() {
    const arena = document.getElementById('arena');
    arena.innerHTML = '';
    document.getElementById('gameOver').style.display = 'none';
    new BeanBattleRoyale();
}

function toggleMute() {
    soundEnabled = !soundEnabled;
    const muteBtn = document.getElementById('muteBtn');
    const isMobile = window.innerWidth <= 768;
    
    if (soundEnabled) {
        muteBtn.innerHTML = isMobile ? 'üîä' : 'üîä SOUND';
        muteBtn.className = 'control-btn';
    } else {
        muteBtn.innerHTML = isMobile ? 'üîá' : 'üîá MUTED';
        muteBtn.className = 'control-btn muted';
    }
}

// ENHANCED RULES POPUP FUNCTIONS
function showRules() {
    console.log('showRules() called - recreating popup');
    
    // Remove existing popup if it exists
    const existingPopup = document.getElementById('rulesPopup');
    if (existingPopup) {
        existingPopup.remove();
    }
    
    // Create completely new popup
    const popup = document.createElement('div');
    popup.id = 'rulesPopup';
    popup.innerHTML = `
        <h2>üìã CANTON ARMY BATTLE RULES</h2>
        <ul>
            <li>üéØ <strong>OBJECTIVE:</strong> Defend your Canton fortress by destroying enemy targets!</li>
            <li>‚öîÔ∏è <strong>SUPER TARGETS:</strong> Give 50 points + big privacy boost</li>
            <li>ü´ò <strong>REGULAR TARGETS:</strong> Give 10 points + small privacy boost</li>
            <li>‚ò†Ô∏è <strong>MALICIOUS TARGETS:</strong> Drain 10% privacy - let them expire naturally!</li>
            <li>üíÄ <strong>CRITICAL THREAT:</strong> Remove health - avoid clicking!</li>
            <li>‚ù§Ô∏è <strong>HEALTH SYSTEM:</strong> Start with 10 hearts - lose 1 for each missed targets</li>
            <li>‚öîÔ∏è <strong>PRIVACY SHIELD:</strong> Constantly drains - keep it above 0 or game over!</li>
            <li>üîó <strong>COMBO SYSTEM:</strong> Hit targets consecutively to multiply your score</li>
            <li>üíÄ <strong>MISS PENALTY:</strong> -50 points + -1 health for targets reaching center</li>
            <li>üéØ <strong>PRECISION:</strong> Miss-clicks reset your combo to zero</li>
            <li>‚è∞ <strong>TIME LIMIT:</strong> 90 seconds + bonuses from leveling up</li>
            <li>üß† <strong>DIFFICULTY:</strong> Targets move 0.1x faster every 1000 points</li>
            <li>üèÜ <strong>WIN CONDITIONS:</strong> Survive as long as possible for high score!</li>
        </ul>
        <button class="rules-close-btn" onclick="hideRules()">Close Rules</button>
    `;
    
    // Style the popup directly
    popup.style.cssText = `
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        z-index: 999999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: rgba(0, 0, 0, 0.95) !important;
        border: 3px solid #a4b848 !important;
        border-radius: 12px !important;
        color: #a4b848 !important;
        font-weight: bold !important;
        max-width: 90vw !important;
        max-height: 100vh !important;
        width: 320px !important;
        overflow-y: auto !important;
        padding: 15px !important;
        font-size: 0.8rem !important;
        line-height: 1.3 !important;
        box-shadow: 0 0 20px rgba(164, 184, 72, 0.8) !important;
    `;
    
    // Add to body
    document.body.appendChild(popup);
    
    console.log('New popup created and should be visible');
}

function hideRules() {
    const popup = document.getElementById('rulesPopup');
    const body = document.body;
    
    popup.style.display = 'none';
    
    const scrollTop = parseInt(body.style.top || '0') * -1;
    body.classList.remove('rules-open');
    body.style.top = '';
    
    window.scrollTo(0, scrollTop);
}

// ADD TOUCH/CLICK OUTSIDE TO CLOSE
document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('rulesPopup');
    
    if (popup) {
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                hideRules();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && popup.style.display === 'block') {
                hideRules();
            }
        });
    }
});

function hideRules() {
    document.getElementById('rulesPopup').style.display = 'none';
}

// Audio event listeners
document.addEventListener('click', (e) => {
    if (!audioContext) {
        initAudio();
        if (audioContext) {
            playTone(440, 0.1);
        }
    }
    
    if (e.target.classList.contains('node')) {
        if (e.target.classList.contains('enemy')) {
            playTone(440 + Math.random() * 200, 0.2);
        } else if (e.target.classList.contains('super')) {
            playTone(660, 0.3);
        } else if (e.target.classList.contains('poison')) {
            playTone(220, 0.4, 'sawtooth');
        } else if (e.target.classList.contains('deadly-poison')) {
            playTone(150, 0.5, 'square');
        }
    }
}, true);

let game = null;

document.getElementById('start-game-button').addEventListener('click', () => {
    document.getElementById('start-banner').style.display = 'none';
    
    document.querySelector('.title').style.display = 'block';
    document.querySelector('.stats').style.display = 'block';
    document.querySelector('.health-bar').style.display = 'flex';
    document.querySelector('.privacy-meter').style.display = 'block';
    document.getElementById('arena').style.display = 'block';
    document.querySelector('.instructions').style.display = 'block';
    document.querySelector('.control-buttons').style.display = 'flex';
    
    // Mobile button fix
    if (window.innerWidth <= 768) {
        document.getElementById('muteBtn').innerHTML = 'üîä';
        const rulesBtn = document.querySelector('.control-buttons button:last-child');
        if (rulesBtn) rulesBtn.innerHTML = 'üìã';
    }
    
    game = new BeanBattleRoyale();
});

// Hide elements initially - SINGLE VERSION
document.addEventListener('DOMContentLoaded', () => {
    const elementsToHide = [
        '.title', '.stats', '.health-bar', '.privacy-meter', 
        '#arena', '.instructions', '.control-buttons'
    ];
    
    elementsToHide.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    const muteBtn = document.getElementById('muteBtn');
    const rulesBtn = document.querySelector('.control-btn:nth-child(2)');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && muteBtn) {
        muteBtn.innerHTML = 'üîä';
        if (rulesBtn) rulesBtn.innerHTML = 'üìã';
    }
});

// ENHANCED MOBILE TOUCH OPTIMIZATION - FIXED NODE CLICKING
document.addEventListener('touchstart', function(e) {
    if (e.target.classList.contains('node')) {
        e.stopPropagation();
    }
}, {passive: false});

document.addEventListener('touchend', function(e) {
    // Handle node clicks properly
    if (e.target.classList.contains('node')) {
        e.preventDefault();
        e.stopPropagation();
        
        const clickEvent = new Event('click', {
            bubbles: true,
            cancelable: true
        });
        e.target.dispatchEvent(clickEvent);
    }
}, {passive: false});

document.addEventListener('touchmove', function(e) {
    if (!e.target.classList.contains('node')) {
        e.preventDefault();
    }
}, {passive: false});

// Additional fix for node touch responsiveness
document.addEventListener('DOMContentLoaded', () => {
    const arena = document.getElementById('arena');
    if (arena) {
        arena.style.touchAction = 'manipulation';
        arena.style.webkitTouchCallout = 'none';
        arena.style.webkitUserSelect = 'none';
    }
});
</script>
</body>
</html>